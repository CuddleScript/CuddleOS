- name: Enable CachyOs repo
  shell: |
   sudo pacman-key --recv-keys F3B607488DB35A47 --keyserver keyserver.ubuntu.com
   sudo pacman-key --lsign-key F3B607488DB35A47
   sudo pacman --needed --noconfirm -U 'https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-keyring-20240331-1-any.pkg.tar.zst' 'https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-mirrorlist-18-1-any.pkg.tar.zst' 'https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-v3-mirrorlist-18-1-any.pkg.tar.zst' 'https://mirror.cachyos.org/repo/x86_64/cachyos/cachyos-v4-mirrorlist-6-1-any.pkg.tar.zst' 'https://mirror.cachyos.org/repo/x86_64/cachyos/pacman-6.1.0-5-x86_64.pkg.tar.zst'

- name: Full system upgrade
  community.general.pacman:
     update_cache: true
     upgrade: true

- name: Install base-devel and git
  shell: 'sudo pacman --needed --noconfirm -S git'

- name: Check if yay is installed
  shell: 'which yay'
  register: yay_check

- name: Install yay
  shell: |
   rm -rf /tmp/yay/
   cd /tmp/
   git clone https://aur.archlinux.org/yay.git
   cd yay
   makepkg -rsi
   cd ..
   rm -rf /tmp/yay/
  when: yay_check.rc != 0

# TODO: ...
#     - name: Install yay packages
#       shell: 'yay install '

- name: Install basic packages
  shell: |
   sudo pacman --needed --noconfirm -Sdd \
    btop \
    neofetch \
    btop \
    neofetch \
    unrar \
    unarchiver \
    unace \
    xz \
    udisks2 \
    jshon \
    expac \
    wget \
    acpid \
    net-tools \
    xdg-user-dirs \
    xf86-input-synaptics \
    xf86-input-libinput \
    xf86-input-evdev \
    mesa \
    lib32-mesa \
    vulkan-icd-loader \
    lib32-vulkan-icd-loader \
    alsa-utils \
    pipewire \
    pipewire-pulse \
    pipewire-jack \
    wireplumber

- name: Check if HDD or SSD
  shell: 'cat /sys/block/sda/queue/rotational'
  register: is_ssd

- name: Enable fstrim if SSD is found
  command: 'fstrim -av'
  when: is_ssd.stdout|int == 0

#- name: Determine Hardware for further installation
